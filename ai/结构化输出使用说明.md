# 结构化输出使用说明

## 实现原理

**直接在 `req.Format` 中设置对象，会自动转换为 function call！**

### 自动处理逻辑

```go
// 如果 Format 是对象（map）
req.Format = schema  // ← 设置 JSON Schema 对象

// 内部自动处理：
// 1. 检测到 Format 是对象
// 2. 创建 function，schema 作为 parameters
// 3. 设置 format: "json"
// 4. 强制调用这个 function
// 5. 从 tool_calls 提取数据

// 如果 Format 是字符串（Ollama 方式）
req.Format = "json"  // ← 保持原样，不转换
```

### 两种用法

| Format 类型 | 处理方式 | 适用场景 |
|------------|---------|---------|
| `map[string]interface{}` | 自动转为 function call | OpenAI, Claude, DeepSeek 等 |
| `"json"` 字符串 | 保持原样 | Ollama, LocalAI |

## 快速开始

兼容所有支持工具调用的提供者（OpenAI、Claude、DeepSeek等）。

### 基本用法

```go
package main

import (
    "github.com/karosown/katool-go/ai"
    "github.com/karosown/katool-go/ai/aiconfig"
)

type User struct {
    Name  string `json:"name" description:"用户姓名"`
    Age   int    `json:"age" description:"用户年龄"`
    Email string `json:"email" description:"用户邮箱"`
}

func main() {
    // 1. 创建客户端
    client, _ := ai.NewClient()

    // 2. 生成 Schema
    schema, _ := ai.FormatFromType[User]()

    // 3. 创建请求，直接设置 Format 为对象
    req := &aiconfig.ChatRequest{
        Model: "gpt-4o-mini",
        Messages: []aiconfig.Message{
            {Role: "user", Content: "生成一个用户信息"},
        },
        Format: schema, // ← 直接设置对象，会自动转为 function call
    }

    // 4. 发送请求（自动处理 Format）
    response, _ := client.Chat(req)

    // 5. 解析结果
    var user User
    ai.UnmarshalStructuredData(response, &user, "extract_structured_data")
    
    println(user.Name, user.Age, user.Email)
}
```

## 数组输出

```go
type QAItem struct {
    Q string `json:"Q" description:"问题"`
    A string `json:"A" description:"答案"`
}

// 生成数组 Schema
schema, _ := ai.FormatArrayOfType[QAItem]()

req := &aiconfig.ChatRequest{
    Model: "gpt-4o-mini",
    Messages: []aiconfig.Message{
        {Role: "user", Content: "给我3个问答"},
    },
    Format: schema, // ← 直接设置数组 schema
}

response, _ := client.Chat(req)

// 解析为数组
var items []QAItem
ai.UnmarshalStructuredData(response, &items, "extract_structured_data")
```

## 核心API

### 直接使用 Chat 方法

```go
// 设置 Format 为对象，自动转换
req.Format = schema
response, _ := client.Chat(req)

// 设置 Format 为字符串，保持原样
req.Format = "json"
response, _ := client.Chat(req)
```

### 辅助函数

```go
// 提取结构化数据为 map
data, err := ai.ExtractStructuredData(response, "")

// 解析到结构体
var result MyStruct
err := ai.UnmarshalStructuredData(response, &result, "")

// 获取原始 JSON 字符串
jsonStr, err := ai.GetStructuredDataJSON(response, "")
```

### Schema 生成

```go
// 从结构体生成
schema, _ := ai.FormatFromStruct(MyStruct{})

// 使用泛型
schema, _ := ai.FormatFromType[MyStruct]()

// 生成数组 Schema
schema, _ := ai.FormatArrayOfType[MyStruct]()

// 从 JSON 字符串生成
schema, _ := ai.FormatFromJSON(`{"name": "John"}`)

// 从 map 生成
schema, _ := ai.FormatFromValue(map[string]interface{}{
    "name": "示例",
    "age": 25,
})
```

### 支持的结构体 Tag

充分利用结构体 tag 来增强 Schema：

```go
type User struct {
    // 基础 tag
    Name string `json:"name" description:"用户姓名"`
    
    // 添加标题和示例
    Email string `json:"email" title:"邮箱" description:"用户邮箱地址" example:"user@example.com"`
    
    // 字符串约束
    Phone string `json:"phone" pattern:"^1[3-9]\\d{9}$" minLength:"11" maxLength:"11"`
    
    // 数字约束
    Age int `json:"age" minimum:"0" maximum:"150"`
    Price float64 `json:"price" minimum:"0"`
    
    // 枚举值
    Gender string `json:"gender" enum:"male,female,other"`
    Status string `json:"status" enum:"active,inactive"`
    
    // 数组约束
    Tags []string `json:"tags" minItems:"1" maxItems:"10"`
    
    // 格式约束（email, uri, date-time 等）
    Website string `json:"website" format:"uri"`
    Birthday string `json:"birthday" format:"date-time"`
}
```

**支持的 Tag：**

| Tag | 适用类型 | 说明 | 示例 |
|-----|---------|------|------|
| `description` / `desc` | 所有 | 字段描述 | `description:"用户姓名"` |
| `title` | 所有 | 字段标题 | `title:"姓名"` |
| `example` | 所有 | 示例值 | `example:"张三"` |
| `enum` | 所有 | 枚举值（逗号分隔） | `enum:"male,female,other"` |
| `pattern` | string | 正则表达式 | `pattern:"^1[3-9]\\d{9}$"` |
| `minLength` | string | 最小长度 | `minLength:"2"` |
| `maxLength` | string | 最大长度 | `maxLength:"50"` |
| `format` | string | 格式类型 | `format:"email"` / `format:"uri"` |
| `minimum` | number | 最小值 | `minimum:"0"` |
| `maximum` | number | 最大值 | `maximum:"150"` |
| `minItems` | array | 最小项数 | `minItems:"1"` |
| `maxItems` | array | 最大项数 | `maxItems:"10"` |

**自动添加的信息：**
- ✅ 结构体名称作为 `title`
- ✅ JSON tag 作为字段名
- ✅ `omitempty` 自动处理为可选字段

## 支持的提供者

| 提供者 | 支持状态 |
|--------|---------|
| OpenAI | ✅ 完全支持 |
| Claude | ✅ 完全支持 |
| DeepSeek | ✅ 完全支持 |
| Ollama | ⚠️ 部分模型支持 |

## Ollama 专用方案

Ollama 的 format 参数只接受 `"json"` 字符串，详见 [OLLAMA_FORMAT_USAGE.md](./OLLAMA_FORMAT_USAGE.md)

```go
req := &aiconfig.ChatRequest{
    Model: "llama3.1",
    Messages: []aiconfig.Message{
        {
            Role: "system",
            Content: "请以JSON格式返回，包含name和age字段",
        },
        {Role: "user", Content: "生成用户信息"},
    },
    Format: "json", // 只接受字符串
    Temperature: 0,
}
```

## 工作流程

```
用户代码
  ↓
client.ChatWithStructuredOutput(req, schema)
  ↓
创建 function tool:
  {
    "type": "function",
    "function": {
      "name": "extract_data",
      "parameters": schema  ← 你的 schema 放这里
    }
  }
  ↓
设置 tool_choice (强制调用) + format: "json"
  ↓
发送请求到 AI 提供者
  ↓
AI 返回 tool_calls
  ↓
从 tool_calls[0].function.arguments 提取数据
  ↓
解析为你的结构体
```

## 示例代码

- 简单示例：[examples/structured_output_simple.go](./examples/structured_output_simple.go)
- 完整示例：[examples/structured_output_universal.go](./examples/structured_output_universal.go)
- Ollama 专用：[examples/ollama_format_example.go](./examples/ollama_format_example.go)

