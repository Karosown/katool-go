# RuleEngine è§„åˆ™å¼•æ“

ä¸€ä¸ªå¼ºå¤§çš„Goè§„åˆ™å¼•æ“ï¼Œæ”¯æŒæ³›å‹ã€å¹¶å‘å®‰å…¨ã€ä¸­é—´ä»¶å’Œæ ‘å½¢è§„åˆ™ç»„ç»‡ã€‚

## ğŸ“¦ å®‰è£…

```bash
go get github.com/karosown/katool-go/ruleengine
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºè§„åˆ™å¼•æ“

```go
import "github.com/karosown/katool-go/ruleengine"

// åˆ›å»ºè§„åˆ™å¼•æ“
engine := ruleengine.NewRuleEngine[int]()

// ç”¨æˆ·æ•°æ®ç±»å‹
type User struct {
    ID       int
    Name     string
    Age      int
    VipLevel int
    Balance  float64
}

userEngine := ruleengine.NewRuleEngine[User]()
```

### 2. æ³¨å†Œè§„åˆ™

```go
// æ³¨å†Œç®€å•è§„åˆ™
engine.RegisterRule("add_ten",
    func(data int, _ any) bool { return data > 0 },  // éªŒè¯å‡½æ•°
    func(data int, _ any) (int, any, error) {        // æ‰§è¡Œå‡½æ•°
        return data + 10, "æ·»åŠ äº†10", nil
    },
)

// æ³¨å†Œç”¨æˆ·è§„åˆ™
userEngine.RegisterRule("validate_age",
    func(user User, _ any) bool { return user.Age > 0 },
    func(user User, _ any) (User, any, error) {
        if user.Age < 18 {
            return user, "æœªæˆå¹´ç”¨æˆ·", nil
        }
        return user, "æˆå¹´ç”¨æˆ·", nil
    },
)
```

### 3. æ„å»ºè§„åˆ™é“¾

```go
// æ„å»ºè§„åˆ™é“¾
_, err := engine.NewBuilder("simple_chain").
    AddRule("add_ten").
    Build()

// æ„å»ºå¤æ‚è§„åˆ™é“¾
_, err := userEngine.NewBuilder("user_processing").
    AddRule("validate_age").
    AddCustomRule(
        func(user User, _ any) bool { return user.Age >= 18 },
        func(user User, _ any) (User, any, error) {
            return user, "æˆå¹´éªŒè¯é€šè¿‡", nil
        },
    ).
    Build()
```

### 4. æ‰§è¡Œè§„åˆ™

```go
// æ‰§è¡Œè§„åˆ™é“¾
result := engine.Execute("simple_chain", 5)
if result.Error != nil {
    fmt.Printf("æ‰§è¡Œå¤±è´¥: %v\n", result.Error)
} else {
    fmt.Printf("ç»“æœ: %d, ä¿¡æ¯: %v\n", result.Data, result.Result)
}

// æ‰¹é‡æ‰§è¡Œ
results := engine.BatchExecute([]string{"chain1", "chain2"}, data)
```

## ğŸ›  é«˜çº§åŠŸèƒ½

### ä¸­é—´ä»¶

```go
// æ·»åŠ æ—¥å¿—ä¸­é—´ä»¶
engine.AddMiddleware(func(data int, next func(int) (int, any, error)) (int, any, error) {
    fmt.Printf("æ‰§è¡Œå‰: %d\n", data)
    result, info, err := next(data)
    fmt.Printf("æ‰§è¡Œå: %d\n", result)
    return result, info, err
})
```

### é”™è¯¯æ§åˆ¶

```go
// ä½¿ç”¨EOFç»ˆæ­¢æ‰§è¡Œ
return data, "æå‰ç»“æŸ", ruleengine.EOF

// ä½¿ç”¨FALLTHROUGHè·³è¿‡ç»§ç»­
return data, "è·³è¿‡ç»§ç»­", ruleengine.FALLTHROUGH
```

#### EOF æœºåˆ¶å¯è§†åŒ– - ç«‹å³ç»ˆæ­¢æ‰§è¡Œ

```
æ­£å¸¸æ‰§è¡Œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è§„åˆ™ A    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™ B    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™ C    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™ D    â”‚
â”‚  (éªŒè¯é€šè¿‡)  â”‚    â”‚  (éªŒè¯é€šè¿‡)  â”‚    â”‚  (éªŒè¯é€šè¿‡)  â”‚    â”‚  (éªŒè¯é€šè¿‡)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       âœ…               âœ…               âœ…               âœ…

EOF ç»ˆæ­¢æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è§„åˆ™ A    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™ B    â”‚ â•³  â”‚   è§„åˆ™ C    â”‚    â”‚   è§„åˆ™ D    â”‚
â”‚  (éªŒè¯é€šè¿‡)  â”‚    â”‚ (è¿”å› EOF)  â”‚    â”‚  (æœªæ‰§è¡Œ)   â”‚    â”‚  (æœªæ‰§è¡Œ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       âœ…               ğŸ›‘               â­•               â­•
                   ç«‹å³ç»ˆæ­¢ï¼Œåç»­è§„åˆ™ä¸æ‰§è¡Œ

è§„åˆ™æ ‘ä¸­çš„ EOFï¼š
                    æ ¹èŠ‚ç‚¹
                       â”‚
                   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
                   â”‚ è§„åˆ™A â”‚ âœ…
                   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
                       â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼          â–¼          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”
        â”‚è§„åˆ™B1â”‚   â”‚è§„åˆ™B2â”‚   â”‚è§„åˆ™B3â”‚
        â”‚ (EOF)â”‚   â”‚(æœªæ‰§è¡Œ)â”‚ â”‚(æœªæ‰§è¡Œ)â”‚
        â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜
            ğŸ›‘         â­•         â­•
        
        å½“B1è¿”å›EOFæ—¶ï¼Œæ•´ä¸ªæ ‘ç«‹å³ç»ˆæ­¢
        B2ã€B3 ä»¥åŠæ‰€æœ‰åç»­èŠ‚ç‚¹éƒ½ä¸ä¼šæ‰§è¡Œ
```

#### FALLTHROUGH æœºåˆ¶å¯è§†åŒ– - è·³è¿‡ç»§ç»­æ‰§è¡Œ

```
æ­£å¸¸æ‰§è¡Œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è§„åˆ™ A    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™ B    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™ C    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™ D    â”‚
â”‚  (éªŒè¯é€šè¿‡)  â”‚    â”‚  (éªŒè¯é€šè¿‡)  â”‚    â”‚  (éªŒè¯é€šè¿‡)  â”‚    â”‚  (éªŒè¯é€šè¿‡)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       âœ…               âœ…               âœ…               âœ…

FALLTHROUGH è·³è¿‡æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è§„åˆ™ A    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™ B    â”‚~~~â–¶â”‚   è§„åˆ™ C    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™ D    â”‚
â”‚  (éªŒè¯é€šè¿‡)  â”‚    â”‚(FALLTHROUGH)â”‚    â”‚  (éªŒè¯é€šè¿‡)  â”‚    â”‚  (éªŒè¯é€šè¿‡)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       âœ…               âš¡               âœ…               âœ…
                   è·³è¿‡ä½†ç»§ç»­æ‰§è¡Œåç»­è§„åˆ™

è§„åˆ™æ ‘ä¸­çš„ FALLTHROUGHï¼š
                      æ ¹èŠ‚ç‚¹
                         â”‚
                     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
                     â”‚ è§„åˆ™A â”‚ âœ…
                     â””â”€â”€â”€â”¬â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼          â–¼          â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”
          â”‚è§„åˆ™B1â”‚   â”‚è§„åˆ™B2â”‚   â”‚è§„åˆ™B3â”‚
          â”‚(FALL)â”‚   â”‚ âœ…   â”‚   â”‚ âœ…   â”‚
          â””â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”€â”˜
             â”‚âš¡       â”‚        â”‚
             â–¼          â–¼          â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”
          â”‚è§„åˆ™C1â”‚   â”‚è§„åˆ™C2â”‚   â”‚è§„åˆ™C3â”‚
          â”‚(è·³è¿‡) â”‚   â”‚ âœ…   â”‚   â”‚ âœ…   â”‚
          â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜
             â­•
        
        å½“B1è¿”å›FALLTHROUGHæ—¶ï¼š
        - B1çš„å­èŠ‚ç‚¹C1è¢«è·³è¿‡
        - B2ã€B3 ç»§ç»­æ­£å¸¸æ‰§è¡Œ
        - C2ã€C3 ç»§ç»­æ­£å¸¸æ‰§è¡Œ
```

#### å¤æ‚åœºæ™¯ç¤ºä¾‹

```go
// ç¤ºä¾‹ï¼šç”¨æˆ·éªŒè¯è§„åˆ™é“¾
engine.RegisterRule("check_age",
    func(user User, _ any) bool { return true },
    func(user User, _ any) (User, any, error) {
        if user.Age < 13 {
            return user, "ç”¨æˆ·è¿‡å°", ruleengine.EOF // ç«‹å³ç»ˆæ­¢ï¼Œä¸å†å¤„ç†
        } else if user.Age < 18 {
            return user, "æœªæˆå¹´ç”¨æˆ·", ruleengine.FALLTHROUGH // è·³è¿‡æˆå¹´ç”¨æˆ·é€»è¾‘
        }
        return user, "æˆå¹´ç”¨æˆ·", nil
    },
)

engine.RegisterRule("adult_verification",
    func(user User, _ any) bool { return user.Age >= 18 },
    func(user User, _ any) (User, any, error) {
        // è¿™ä¸ªè§„åˆ™åœ¨ FALLTHROUGH æ—¶ä¼šè¢«è·³è¿‡
        return user, "æˆå¹´éªŒè¯å®Œæˆ", nil
    },
)

engine.RegisterRule("final_process",
    func(user User, _ any) bool { return true },
    func(user User, _ any) (User, any, error) {
        return user, "æœ€ç»ˆå¤„ç†", nil
    },
)

// æ‰§è¡Œç»“æœåˆ†æï¼š
ç”¨æˆ·å¹´é¾„ 12: check_age(EOF) â†’ ç«‹å³ç»ˆæ­¢ï¼Œåç»­è§„åˆ™éƒ½ä¸æ‰§è¡Œ
ç”¨æˆ·å¹´é¾„ 16: check_age(FALLTHROUGH) â†’ adult_verification(è·³è¿‡) â†’ final_process(æ‰§è¡Œ)
ç”¨æˆ·å¹´é¾„ 25: check_age(æ­£å¸¸) â†’ adult_verification(æ‰§è¡Œ) â†’ final_process(æ‰§è¡Œ)
```

#### æ ‘å½¢ç»“æ„ä¸­çš„æ··åˆåœºæ™¯

```
å¤æ‚è§„åˆ™æ ‘ç¤ºä¾‹ï¼š
                        æ ¹èŠ‚ç‚¹
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚  å¹´é¾„æ£€æŸ¥    â”‚
                    â”‚ (å¯èƒ½è¿”å›EOF) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â–¼           â–¼           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”
           â”‚èº«ä»½éªŒè¯â”‚    â”‚é‚®ç®±éªŒè¯â”‚    â”‚æ‰‹æœºéªŒè¯â”‚
           â”‚(æ­£å¸¸) â”‚    â”‚(FALL) â”‚    â”‚(æ­£å¸¸) â”‚
           â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”¬â”€â”€â”€â”˜
              â”‚           â”‚âš¡         â”‚
              â–¼           â–¼           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”
           â”‚æƒé™æ£€æŸ¥â”‚    â”‚é‚®ç®±é…ç½®â”‚    â”‚çŸ­ä¿¡é…ç½®â”‚
           â”‚ âœ…   â”‚    â”‚(è·³è¿‡) â”‚    â”‚ âœ…   â”‚
           â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œæµç¨‹è¯´æ˜ï¼š
1. æ ¹èŠ‚ç‚¹å¹´é¾„æ£€æŸ¥ï¼š
   - å¦‚æœè¿”å› EOF â†’ æ•´ä¸ªæ ‘ç«‹å³ç»ˆæ­¢
   - å¦‚æœæ­£å¸¸ â†’ ç»§ç»­æ‰§è¡Œä¸‰ä¸ªåˆ†æ”¯

2. ä¸‰ä¸ªå¹¶è¡Œåˆ†æ”¯ï¼š
   - èº«ä»½éªŒè¯ â†’ æƒé™æ£€æŸ¥ (æ­£å¸¸æ‰§è¡Œ)
   - é‚®ç®±éªŒè¯ â†’ è¿”å›FALLTHROUGH â†’ é‚®ç®±é…ç½®è¢«è·³è¿‡
   - æ‰‹æœºéªŒè¯ â†’ çŸ­ä¿¡é…ç½® (æ­£å¸¸æ‰§è¡Œ)

3. æœ€ç»ˆç»“æœï¼šé™¤äº†é‚®ç®±é…ç½®ï¼Œå…¶ä»–éƒ½æ­£å¸¸æ‰§è¡Œ
```

## ğŸŒ³ è§„åˆ™æ ‘ä½¿ç”¨

```go
type TestData struct {
    Value int
}

// åˆ›å»ºè§„åˆ™èŠ‚ç‚¹
leafNode := ruleengine.NewRuleNode[TestData](
    func(data TestData, _ any) bool { return data.Value > 5 },
    func(data TestData, _ any) (TestData, any, error) {
        return TestData{Value: data.Value + 10}, "å¤„ç†å®Œæˆ", nil
    },
)

// åˆ›å»ºè§„åˆ™æ ‘
tree := ruleengine.NewRuleTree[TestData](leafNode)

// æ‰§è¡Œè§„åˆ™æ ‘
result, info, err := tree.Run(TestData{Value: 3})
```

## ğŸ“ å®Œæ•´ç¤ºä¾‹

```go
func main() {
    engine := ruleengine.NewRuleEngine[User]()

    // æ³¨å†Œè§„åˆ™
    engine.RegisterRule("validate_age",
        func(user User, _ any) bool { return user.Age > 0 },
        func(user User, _ any) (User, any, error) {
            if user.Age < 18 {
                return user, "æœªæˆå¹´", nil
            }
            return user, "æˆå¹´", nil
        },
    )

    // æ„å»ºè§„åˆ™é“¾
    engine.NewBuilder("user_chain").AddRule("validate_age").Build()

    // æ‰§è¡Œ
    user := User{Name: "å¼ ä¸‰", Age: 25}
    result := engine.Execute("user_chain", user)
    fmt.Printf("ç»“æœ: %v\n", result.Result)
}
```

## ğŸ”§ æ³¨æ„äº‹é¡¹

- éœ€è¦ Go 1.18+ (æ³›å‹æ”¯æŒ)
- çº¿ç¨‹å®‰å…¨ï¼Œæ”¯æŒå¹¶å‘æ‰§è¡Œ
- `EOF`: ç»ˆæ­¢è§„åˆ™é“¾
- `FALLTHROUGH`: è·³è¿‡å½“å‰è§„åˆ™
- è§„åˆ™å‘½åå»ºè®®: `åŠ¨è¯_åè¯` æ ¼å¼

## ğŸ“š API å‚è€ƒ

### ä¸»è¦æ–¹æ³•

- `NewRuleEngine[T]()` - åˆ›å»ºå¼•æ“
- `RegisterRule(name, valid, exec)` - æ³¨å†Œè§„åˆ™
- `NewBuilder(name)` - åˆ›å»ºæ„å»ºå™¨
- `Execute(chain, data)` - æ‰§è¡Œè§„åˆ™é“¾
- `BatchExecute(chains, data)` - æ‰¹é‡æ‰§è¡Œ
- `AddMiddleware(middleware)` - æ·»åŠ ä¸­é—´ä»¶